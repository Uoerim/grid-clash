# plot_results.py
"""
Plotting helper for CSE361 Grid Clash (Phase 2)

Reads CSVs generated by server/client:

- logs/server_events.csv
- logs/server_metrics.csv
- logs/client_snapshots_*.csv

and produces PNG plots for use in the report.

Usage:
    python plot_results.py
    python plot_results.py --logs ./logs
    python plot_results.py --logs ./results/baseline_2025_.../logs
"""

import argparse
import glob
import os

import matplotlib.pyplot as plt
import pandas as pd


def load_csv(path):
    if not os.path.exists(path):
        print(f"[WARN] CSV not found: {path}")
        return None
    try:
        df = pd.read_csv(path)
        if df.empty:
            print(f"[WARN] CSV is empty: {path}")
            return None
        return df
    except Exception as e:
        print(f"[WARN] Failed to read {path}: {e}")
        return None


# ---------------------------------------------------------------------
# 1) Server event latency (client -> server)
# ---------------------------------------------------------------------
def plot_server_event_latency(log_dir, out_dir):
    events_path = os.path.join(log_dir, "server_events.csv")
    df = load_csv(events_path)
    if df is None:
        return

    # Ensure sorted by timestamp
    df = df.sort_values("timestamp_ms")

    # --- Plot latency over time (per player) ---
    plt.figure()
    for player_id, group in df.groupby("player_id"):
        plt.plot(
            group["timestamp_ms"] - group["timestamp_ms"].min(),
            group["latency_ms"],
            marker=".",
            linestyle="-",
            label=f"player {player_id}",
        )

    plt.xlabel("Time since start (ms)")
    plt.ylabel("Event latency (ms)")
    plt.title("Server: Event latency over time")
    plt.legend()
    plt.grid(True)
    out_path = os.path.join(out_dir, "server_event_latency_time.png")
    plt.savefig(out_path, bbox_inches="tight")
    plt.close()
    print(f"[OUT] {out_path}")

    # --- Histogram of event latency ---
    plt.figure()
    plt.hist(df["latency_ms"], bins=30)
    plt.xlabel("Event latency (ms)")
    plt.ylabel("Count")
    plt.title("Server: Event latency distribution")
    plt.grid(True)
    out_path = os.path.join(out_dir, "server_event_latency_hist.png")
    plt.savefig(out_path, bbox_inches="tight")
    plt.close()
    print(f"[OUT] {out_path}")


# ---------------------------------------------------------------------
# 2) Client snapshot latency & jitter (server -> client)
# ---------------------------------------------------------------------
def plot_client_snapshot_latency(log_dir, out_dir):
    pattern = os.path.join(log_dir, "client_snapshots_*.csv")
    files = glob.glob(pattern)

    if not files:
        print(f"[WARN] No client_snapshots_*.csv in {log_dir}")
        return

    # --- Latency over time (one line per client) ---
    plt.figure()
    for path in files:
        df = load_csv(path)
        if df is None:
            continue
        df = df.sort_values("client_rx_ms")
        t0 = df["client_rx_ms"].min()
        label = os.path.basename(path).replace(".csv", "")
        plt.plot(
            df["client_rx_ms"] - t0,
            df["latency_ms"],
            marker=".",
            linestyle="-",
            label=label,
        )

    plt.xlabel("Time since first snapshot (ms)")
    plt.ylabel("Snapshot latency (ms)")
    plt.title("Client: Snapshot latency over time")
    plt.legend()
    plt.grid(True)
    out_path = os.path.join(out_dir, "client_snapshot_latency_time.png")
    plt.savefig(out_path, bbox_inches="tight")
    plt.close()
    print(f"[OUT] {out_path}")

    # --- Jitter over time (per client) ---
    plt.figure()
    for path in files:
        df = load_csv(path)
        if df is None:
            continue
        df = df.sort_values("client_rx_ms")
        t0 = df["client_rx_ms"].min()
        label = os.path.basename(path).replace(".csv", "")
        if "jitter_ms" not in df.columns:
            print(f"[WARN] No jitter_ms column in {path} (skipping jitter plot)")
            continue

        plt.plot(
            df["client_rx_ms"] - t0,
            df["jitter_ms"],
            marker=".",
            linestyle="-",
            label=label,
        )

    plt.xlabel("Time since first snapshot (ms)")
    plt.ylabel("Jitter (|Î” latency|, ms)")
    plt.title("Client: Snapshot jitter over time")
    plt.legend()
    plt.grid(True)
    out_path = os.path.join(out_dir, "client_snapshot_jitter_time.png")
    plt.savefig(out_path, bbox_inches="tight")
    plt.close()
    print(f"[OUT] {out_path}")


# ---------------------------------------------------------------------
# 3) Server snapshot rate / clients over time
# ---------------------------------------------------------------------
def plot_server_snapshot_rate(log_dir, out_dir):
    metrics_path = os.path.join(log_dir, "server_metrics.csv")
    df = load_csv(metrics_path)
    if df is None:
        return

    df = df.sort_values("timestamp_ms")

    # --- Snapshot ID vs time ---
    plt.figure()
    t0 = df["timestamp_ms"].min()
    plt.plot(
        df["timestamp_ms"] - t0,
        df["snapshot_id"],
        marker=".",
        linestyle="-",
    )
    plt.xlabel("Time since start (ms)")
    plt.ylabel("Snapshot id")
    plt.title("Server: Snapshot stream over time")
    plt.grid(True)
    out_path = os.path.join(out_dir, "server_snapshot_stream.png")
    plt.savefig(out_path, bbox_inches="tight")
    plt.close()
    print(f"[OUT] {out_path}")

    # --- Number of clients vs time ---
    plt.figure()
    plt.plot(
        df["timestamp_ms"] - t0,
        df["num_clients"],
        marker=".",
        linestyle="-",
    )
    plt.xlabel("Time since start (ms)")
    plt.ylabel("Number of clients")
    plt.title("Server: Number of clients over time")
    plt.grid(True)
    out_path = os.path.join(out_dir, "server_num_clients_time.png")
    plt.savefig(out_path, bbox_inches="tight")
    plt.close()
    print(f"[OUT] {out_path}")


# ---------------------------------------------------------------------
# main
# ---------------------------------------------------------------------
def main():
    parser = argparse.ArgumentParser(
        description="Plot Grid Clash experiment results (Phase 2)."
    )
    parser.add_argument(
        "--logs",
        type=str,
        default="./logs",
        help="Path to logs directory (containing CSVs). Default: ./logs",
    )
    parser.add_argument(
        "--out",
        type=str,
        default="./plots",
        help="Output directory for PNG files. Default: ./plots",
    )
    args = parser.parse_args()

    log_dir = os.path.abspath(args.logs)
    out_dir = os.path.abspath(args.out)

    if not os.path.isdir(log_dir):
        print(f"[ERR] Logs directory not found: {log_dir}")
        return

    os.makedirs(out_dir, exist_ok=True)
    print(f"[INFO] Using logs dir: {log_dir}")
    print(f"[INFO] Output plots dir: {out_dir}")

    plot_server_event_latency(log_dir, out_dir)
    plot_client_snapshot_latency(log_dir, out_dir)
    plot_server_snapshot_rate(log_dir, out_dir)

    print("[DONE] Plots generated.")


if __name__ == "__main__":
    main()
